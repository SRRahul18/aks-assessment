name: PR Validation

on:
  pull_request:
    branches: [ "main" ]

jobs:
  validate:
    runs-on: ubuntu-latest
    environment: development

    steps:
      # Checkout the PR branch
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          cd src/
          docker build -t hello-node:pr-${{ github.run_id }} .

      - name: Scan yamls
        id: kube-lint-scan
        uses: stackrox/kube-linter-action@v1
        with:
          directory: src/hello-node-aks
          config: .kube-linter/config.yaml


      # Validate Kubernetes YAML syntax
      - name: Validate manifests with kubectl dry-run
        run: |
          kubectl apply --dry-run=client -k "src/hello-node-aks/overlays/${{ vars.ENVIRONMENT }}"
